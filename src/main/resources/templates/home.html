<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <style>
    body {
      text-align: center;
    }

    button {
      padding: 8px;
    }
    #message {
      color: #996600;
    }

    .textWrapper {
      width: 800px;
      margin: 0 auto;
      display: flex;
      flex-direction: row;
    }
    .textbox {
      height: 100px;
      border: 1px solid #d3d3d3;
      flex: 1;
      margin: 5px 15px;
      border-radius: 6px;
      text-align: left;
      padding: 16px;
    }
  </style>
  <script
    type="text/javascript"
    src="https://code.jquery.com/jquery-3.3.1.js"
  ></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>  -->
  <head>
    <meta charset="UTF-8" />
    <title>주니어스토리</title>
  </head>
  <body>
    <h1>메인 페이지</h1>
    <p><span th:text="${session.user.username}"></span>님 환영합니다</p>
    <a href="logout"> Logout </a>
    <hr />
    <h1>TEST!</h1>

    <button id="speech" onclick="speech_to_text()">Start STT</button>
    <button id="stop" onclick="stop()">Stop</button>
    <p id="message">버튼을 누르고 아무말이나 하세요.</p>

    <div class="textWrapper">
      <div id="korea" class="textbox"></div>
      <!-- <div id="english" class="textbox"></div> -->
    </div>

    <script type="text/javascript">
      var message = document.querySelector("#message");
      var button = document.querySelector("#speech");
      var korea = document.querySelector("#korea");
      var english = document.querySelector("#english");
      var isRecognizing = false;

      if ("SpeechRecognition" in window) {
        // Speech recognition support. Talk to your apps!
        console.log("음성인식을 지원하는 브라우저입니다.");
      }

      try {
        //음성인식 부여
        var recognition = new (window.SpeechRecognition ||
          window.webkitSpeechRecognition ||
          window.mozSpeechRecognition ||
          window.msSpeechRecognition)();
      } catch (e) {
        console.error(e);
      }

      recognition.lang = "ko-KR";
      recognition.interimResults = false; //중간 결과가 반환되어야 하는지(true) 아니면 반환 되지 않아야 하는지 (false) 제어
      recognition.maxAlternatives = 5; // 결과당 제공되는 최대 s 수를 설정
      //recognition.continuous = true;

      function speech_to_text() {
        recognition.start(); //stt 시작
        isRecognizing = true;

        recognition.onstart = function () {
          console.log(
            "음성인식이 시작 되었습니다. 이제 마이크에 무슨 말이든 하세요."
          );
          message.innerHTML = "음성인식 시작...";
          button.innerHTML = "Listening...";
          button.disabled = true;
        };

        recognition.onspeechend = function () {
          //음성 인식 서비스에서 인식한 음성이 감지되지 않을 때
          recognition.stop(); //stt 정지 및 기본값 복귀
          message.innerHTML = "버튼을 누르고 아무말이나 하세요.";
          button.disabled = false;
          button.innerHTML = "Start STT";
        };

        recognition.onresult = function (event) {
          console.log("You said: ", event.results[0][0].transcript);
          // 결과를 출력
          var resText = event.results[0][0].transcript;
          korea.innerHTML = resText;

          if (resText == "정답") korea.innerHTML = "포인트해결"; // 포인트 일치시 이벤트 처리 가능해짐

          //text to sppech
          //  text_to_speech(resText);
        };
      }

      function stop() {
        //스탑버튼 당장은 필요X
        recognition.stop();
        message.innerHTML = "버튼을 누르고 아무말이나 하세요.";
        button.disabled = false;
        button.innerHTML = "Start STT";
        isRecognizing = false;
      }

      // Text to speech
      //  function text_to_speech(txt){
      //      // Web Speech API - speech synthesis
      //      if ('speechSynthesis' in window) {
      //       // Synthesis support. Make your web apps talk!
      //           console.log("음성합성을 지원하는  브라우저입니다.");
      //      }
      //      var msg = new SpeechSynthesisUtterance();
      //      var voices = window.speechSynthesis.getVoices();
      //      //msg.voice = voices[10]; // 두번째 부터 완전 외국인 발음이 됨. 사용하지 말것.
      //      msg.voiceURI = 'native';
      //      msg.volume = 1; // 0 to 1
      //      msg.rate = 1.3; // 0.1 to 10
      //      //msg.pitch = 2; //0 to 2
      //      msg.text = txt;
      //      msg.lang = 'ko-KR';

      //     msg.onend = function(e) {
      //          if(isRecognizing == false){
      //              recognition.start();
      //          }
      //            console.log('Finished in ' + event.elapsedTime + ' seconds.');
      //      };
      //      window.speechSynthesis.speak(msg);
      //  }
    </script>
  </body>
</html>
